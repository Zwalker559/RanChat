/**
 * @file firestore.rules
 * @description Firestore security rules for the RanChat application.
 *
 * @section Core Philosophy
 * This ruleset enforces a security model centered on user ownership and explicit sharing.
 * User-specific data is stored within a user's own document tree, making it private by default.
 * Shared data, such as chat sessions, relies on denormalized participant IDs within documents
 * to grant access to a specific, closed set of collaborators.
 *
 * @section Data Structure
 * - /users/{userId}: Private user profile data. Each user owns their document.
 * - /queue/{userId}: Temporary document for users waiting for a match.
 * - /chats/{chatId}: Chat metadata and messages. Access is shared between participants.
 * - /active_users/{userId}: Publicly readable presence information, but writable only by the owner.
 *
 * @section Key Security Decisions
 * - User Isolation: Users cannot read, list, or modify another user's private data in the `/users` collection.
 * - Shared Chat Access: Access to chat sessions and messages is granted if the user's ID is one of the participants listed in the Chat document.
 * - Public Presence: The `/active_users` collection is readable by any signed-in user, but each user can only manage their own presence.
 *
 * @section Denormalization for Authorization
 * To create performant and secure rules, authorization data is denormalized:
 * - Chat documents contain a `participants` array. This allows rules to check for participation without needing slow and costly `get` or `exists` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for reusable logic
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isChatParticipant(chatDoc) {
      return isSignedIn() && request.auth.uid in chatDoc.data.participants;
    }

    /**
     * @description Manages user profile data.
     * @path /users/{userId}
     */
    match /users/{userId} {
      // A user can read their own profile, but nobody else's.
      allow get: if isOwner(userId);
      // No one can list all users.
      allow list: if false;
      // A user can create their own profile document.
      allow create: if isOwner(userId);
      // A user can update their own profile (e.g., status, preferences).
      allow update: if isOwner(userId);
      // A user can delete their own profile document.
      allow delete: if isOwner(userId);
    }
    
    /**
     * @description Stores online presence for active users. Data is public for reads.
     * @path /active_users/{userId}
     */
    match /active_users/{userId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Manages the matchmaking queue.
     * @path /queue/{userId}
     */
    match /queue/{userId} {
      // Allow any signed-in user to read the queue to find a match
      allow list, get: if isSignedIn();
      // Allow a user to add/remove themselves from the queue
      allow write: if isOwner(userId);
    }
    
    /**
     * @description Manages chat sessions and their subcollections.
     * @path /chats/{chatId}
     */
    match /chats/{chatId} {
      // Allow participants to get or delete the chat doc.
      allow get, delete: if isChatParticipant(resource);
      // Allow any signed-in user to create a chat if they are a participant.
      allow create: if isSignedIn() && request.auth.uid in request.resource.data.participants;
      // Allow a user to list chats where they are a participant.
      // This is crucial for the listenForPartner function.
      allow list: if isSignedIn() && request.query.get("participants") != null && request.auth.uid == request.query.get("participants")[0];
      
      // Rules for WebRTC signaling subcollection
      match /peers/{peerId} {
        allow get, create, update, delete: if isChatParticipant(get(/databases/$(database)/documents/chats/$(chatId)));
        
        match /iceCandidates/{candidateId} {
           allow get, create, list: if isChatParticipant(get(/databases/$(database)/documents/chats/$(chatId)));
        }
      }
      
      // Rules for messages subcollection
      match /messages/{messageId} {
        allow list, get: if isChatParticipant(get(/databases/$(database)/documents/chats/$(chatId)));
        allow create: if isSignedIn() && request.auth.uid == request.resource.data.senderId && isChatParticipant(get(/databases/$(database)/documents/chats/$(chatId)));
      }
    }
  }
}
